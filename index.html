<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e ã¡ã‚ƒã‚“ã­ã‚‹</title>
    <style>
        :root { --e-green: #5cb85c; --e-purple: #4b0082; --bg-light-green: #f4f9f4; }
        html, body { margin: 0; padding: 0; background-color: white; min-height: 100vh; font-family: sans-serif; }
        header { padding: 40px 20px 20px; text-align: center; }
        .logo-text { font-size: 42px; color: var(--e-green); font-weight: bold; margin: 0; }
        .sub-title { font-size: 20px; color: var(--e-green); margin: 20px 0; font-weight: bold; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        /* åˆ©ç”¨è¦ç´„ */
        .terms-box { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 12px; color: #666; }
        .terms-content { height: 60px; overflow-y: auto; margin-bottom: 5px; }

        .btn-create { background-color: var(--e-green); color: white; border: none; padding: 12px; border-radius: 6px; font-size: 16px; cursor: pointer; margin-bottom: 25px; font-weight: bold; width: 100%; }
        
        .board-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .board-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .board-title { font-size: 16px; color: var(--e-purple); font-weight: bold; }
        
        #bbs-view { display: none; background: white; padding: 20px; }
        .form-input { width: 100%; max-width: 200px; border: 1px solid #ccc; padding: 8px; margin-bottom: 10px; border-radius: 4px; }
        .form-textarea { width: 100%; border: 1px solid #ccc; padding: 10px; border-radius: 4px; height: 100px; box-sizing: border-box; }
        
        /* æŠ•ç¨¿ã‚¢ã‚¤ãƒ†ãƒ  */
        .post-item { border-bottom: 1px solid #f0f0f0; padding: 15px 0; position: relative; }
        .post-header { display: flex; justify-content: space-between; font-size: 13px; }
        .post-user { font-weight: bold; color: var(--e-purple); }
        .post-text { margin: 8px 0; white-space: pre-wrap; line-height: 1.5; }
        .anchor { color: #0000ee; text-decoration: underline; cursor: pointer; }
        
        /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
        .reaction-bar { display: flex; gap: 8px; margin-top: 8px; }
        .reaction-btn { background: #f0f0f0; border: 1px solid #ddd; border-radius: 12px; padding: 2px 8px; font-size: 12px; cursor: pointer; }
        .reaction-btn:hover { background: #e0e0e0; }

        /* ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆã‚­ãƒ¼ & ç®¡ç† */
        .post-footer { font-size: 11px; color: #999; margin-top: 8px; display: flex; align-items: center; gap: 10px; }
        .ap-key { color: #555; background: #eee; padding: 0 4px; border-radius: 3px; font-family: monospace; }
        .admin-del { cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<header id="header-part">
    <h1 class="logo-text">e ã¡ã‚ƒã‚“ã­ã‚‹</h1>
    <div class="sub-title">æ²ç¤ºæ¿ä¸€è¦§</div>
</header>

<div class="container" id="top-view">
    <div class="terms-box">
        <h3>åˆ©ç”¨è¦ç´„</h3>
        <div class="terms-content">
            èª¹è¬—ä¸­å‚·ã€è’ã‚‰ã—è¡Œç‚ºã‚’ç¦ã˜ã¾ã™ã€‚è¦ç´„é•åè€…ã¯ç®¡ç†è€…ã®åˆ¤æ–­ã§BANã€ãŠã‚ˆã³è­˜åˆ¥æƒ…å ±(IPã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰)ã‚’å…¬é–‹ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
        </div>
    </div>
    <button class="btn-create" onclick="createNewBoard()">æ²ç¤ºæ¿ã‚’ä½œæˆã™ã‚‹</button>
    <div class="board-grid" id="board-list"></div>
</div>

<div class="container" id="bbs-view">
    <input type="text" id="username" class="form-input" placeholder="åå‰">
    <textarea id="content" class="form-textarea" placeholder="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„... >>1 ã§ã‚¢ãƒ³ã‚«ãƒ¼"></textarea>
    <div style="margin: 10px 0;">
        <button class="btn-green" id="send-btn" style="background:var(--e-green); color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer;">æŠ•ç¨¿</button>
        <button onclick="location.reload()" style="padding:8px; border-radius:4px; border:1px solid #ccc; cursor:pointer; margin-left:10px;">æˆ»ã‚‹</button>
    </div>
    <div id="message-container"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCwhHspaG94goiCIjVj3h-Un5pBK3JTjMU",
        authDomain: "soulkin-aa3b7.firebaseapp.com",
        projectId: "soulkin-aa3b7",
        appId: "1:358331064206:web:d7760ea0919259418a4edf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ADMIN_PASS = "ZGVsdGE0Mzc="; 

    const sanitize = (str) => str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    
    // ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ãƒªãƒ³ã‚¯åŒ–ã™ã‚‹é–¢æ•°
    const parseAnchor = (text) => {
        return text.replace(/&gt;&gt;(\d+)/g, '<span class="anchor" onclick="document.getElementById(\'post-$1\').scrollIntoView()">>>$1</span>');
    };

    const myId = (() => {
        let id = localStorage.getItem('fp');
        if (!id) { id = 'fp_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('fp', id); }
        return id;
    })();

    let currentBoardId = '';

    // åˆæœŸãƒã‚§ãƒƒã‚¯ (BAN & åå‰èª­ã¿è¾¼ã¿)
    (async () => {
        const blackSnap = await getDoc(doc(db, 'blacklist', myId));
        if (blackSnap.exists() && blackSnap.data().type === 'perm') {
            location.href = "https://soulkin19.github.io/soulch_ura";
        }
        document.getElementById('username').value = localStorage.getItem('e_chan_name') || "åç„¡ã—ã•ã‚“";
    })();

    // æ²ç¤ºæ¿ä¸€è¦§
    onSnapshot(query(collection(db, 'boards'), orderBy('lastUpdated', 'desc')), (snap) => {
        const list = document.getElementById('board-list');
        list.innerHTML = '';
        snap.forEach(d => {
            const card = document.createElement('div');
            card.className = 'board-card';
            card.innerHTML = `<div class="board-title">${sanitize(d.data().title)}</div>`;
            card.onclick = () => openBoard(d.id);
            list.appendChild(card);
        });
    });

    window.openBoard = (id) => {
        currentBoardId = id;
        document.getElementById('top-view').style.display = 'none';
        document.getElementById('header-part').style.display = 'none';
        document.getElementById('bbs-view').style.display = 'block';
        
        onSnapshot(query(collection(db, `boards/${id}/messages`), orderBy('timestamp', 'asc')), (snap) => {
            const container = document.getElementById('message-container');
            container.innerHTML = '';
            let count = 1;
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = 'post-item';
                div.id = `post-${count}`;
                const shortId = m.uid ? m.uid.slice(-4).toUpperCase() : '????'; // APã‚­ãƒ¼
                
                div.innerHTML = `
                    <div class="post-header">
                        <span class="post-user">${count}: ${sanitize(m.username)}</span>
                        <span>${new Date(m.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="post-text">${parseAnchor(sanitize(m.text))}</div>
                    <div class="reaction-bar">
                        <button class="reaction-btn" onclick="react('${d.id}', 'kusa')">ğŸ˜‚ ${m.kusa || 0}</button>
                        <button class="reaction-btn" onclick="react('${d.id}', 'good')">ğŸ‘ ${m.good || 0}</button>
                        <button class="reaction-btn" onclick="react('${d.id}', 'kami')">ğŸ˜² ${m.kami || 0}</button>
                    </div>
                    <div class="post-footer">
                        <span>ID: <span class="ap-key">${shortId}</span></span>
                        <span class="admin-del" onclick="admin('${d.id}', '${m.uid}')">[ç®¡ç†]</span>
                    </div>
                `;
                container.prepend(div); // æ–°ã—ã„é †ã«è¡¨ç¤º
                count++;
            });
        });
    };

    window.react = async (mId, type) => {
        const ref = doc(db, `boards/${currentBoardId}/messages`, mId);
        await updateDoc(ref, { [type]: increment(1) });
    };

    document.getElementById('send-btn').onclick = async () => {
        const txt = document.getElementById('content').value;
        const name = document.getElementById('username').value;
        if (!txt) return;
        localStorage.setItem('e_chan_name', name);
        const now = Date.now();
        await addDoc(collection(db, `boards/${currentBoardId}/messages`), {
            username: name, text: txt, timestamp: now, uid: myId, kusa:0, good:0, kami:0
        });
        await updateDoc(doc(db, 'boards', currentBoardId), { lastUpdated: now });
        document.getElementById('content').value = '';
    };

    window.admin = async (mId, uId) => {
        const p = prompt("PASS:");
        if (p && btoa(p) === ADMIN_PASS) {
            const a = prompt("1:æ¶ˆå» 2:æ°¸ä¹…BAN");
            if (a === "1") await deleteDoc(doc(db, `boards/${currentBoardId}/messages`, mId));
            else if (a === "2") await setDoc(doc(db, 'blacklist', uId), { type: 'perm' });
        }
    };

    window.createNewBoard = async () => {
        const t = prompt("æ²ç¤ºæ¿å:");
        if (t) await addDoc(collection(db, 'boards'), { title: t, lastUpdated: Date.now() });
    };
</script>
</body>
</html>
