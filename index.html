<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e ã¡ã‚ƒã‚“ã­ã‚‹</title>
    <style>
        :root { --e-green: #5cb85c; --e-purple: #4b0082; }
        html, body { margin: 0; padding: 0; background-color: white; min-height: 100vh; font-family: sans-serif; }
        header { padding: 40px 20px 20px; text-align: center; }
        .logo-text { font-size: 42px; color: var(--e-green); font-weight: bold; margin: 0; }
        .sub-title { font-size: 20px; color: var(--e-green); margin: 20px 0; font-weight: bold; }
        .logo-img { width: 80px; height: 80px; margin: 10px auto; background-color: #e3f2fd; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .logo-img img { width: 60px; height: auto; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        .terms-box { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; color: #555; line-height: 1.6; }
        .terms-box h3 { margin-top: 0; color: #333; font-size: 15px; }
        .terms-content { height: 180px; overflow-y: scroll; border-bottom: 1px solid #eee; margin-bottom: 10px; padding-bottom: 5px; }
        .terms-important { color: #d9534f; font-weight: bold; }

        .btn-reg { background-color: #337ab7; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; margin-bottom: 20px; font-weight: bold; width: 100%; display: block; text-decoration: none; text-align: center; box-sizing: border-box; }

        .btn-create { background-color: var(--e-green); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; margin-bottom: 25px; font-weight: bold; width: 100%; }
        
        .board-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .board-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; }
        .board-title { font-size: 16px; color: var(--e-purple); font-weight: bold; margin-bottom: 8px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .post-count { font-size: 12px; color: #888; text-decoration: underline; }
        .board-del { position: absolute; top: 8px; right: 8px; color: #ddd; font-size: 18px; cursor: pointer; border: none; background: none; }
        .lock-icon { margin-right: 5px; }

        #bbs-view { display: none; background: white; padding: 20px; }
        #current-board-title { font-size: 24px; color: var(--e-purple); font-weight: bold; margin-bottom: 20px; border-left: 5px solid var(--e-green); padding-left: 10px; }
        .form-input { width: 100%; max-width: 200px; border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .form-textarea { width: 100%; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 4px; height: 120px; box-sizing: border-box; }
        .img-preview { max-width: 100px; margin-bottom: 10px; border: 1px solid #ddd; display: none; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 30px; }
        .btn-green { background-color: var(--e-green); color: white; border: none; padding: 10px 25px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .post-item { border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
        .post-user { font-weight: bold; color: #444; }
        .post-text { margin-top: 5px; white-space: pre-wrap; word-wrap: break-word; }
        .post-img { max-width: 150px; border-radius: 4px; margin-top: 10px; border: 1px solid #eee; cursor: pointer; }
        .post-time { font-size: 11px; color: #aaa; margin-top: 5px; }
        .anchor { color: #0000ee; text-decoration: underline; cursor: pointer; }

        .reaction-bar { display: flex; gap: 8px; margin-top: 10px; }
        .reaction-btn { background: #f8f9fa; border: 1px solid #eee; border-radius: 15px; padding: 4px 10px; font-size: 12px; cursor: pointer; user-select: none; }
        .reaction-btn:active { background: #ddd; }

        .post-footer { font-size: 11px; color: #aaa; margin-top: 8px; }
        .ap-key { background: #eee; color: #666; padding: 1px 4px; border-radius: 3px; font-family: monospace; margin-right: 8px; }
        .admin-del { cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<header id="header-part">
    <h1 class="logo-text">e ã¡ã‚ƒã‚“ã­ã‚‹</h1>
    <div class="sub-title">æ²ç¤ºæ¿ä¸€è¦§</div>
</header>

<div class="container" id="top-view">
    <div class="terms-box">
        <h3>åˆ©ç”¨è¦ç´„ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ ï¼† ç„¡æ–™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç‰¹å…¸</h3>
        <div class="terms-content">
            <strong>ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ï¼ˆç„¡æ–™ï¼‰ã§ã§ãã‚‹ã“ã¨ã€‘</strong><br>
            ãƒ»<b>é™å®šéƒ¨å±‹ï¼ˆğŸ”’ï¼‰ã®é–²è¦§ãƒ»æŠ•ç¨¿</b>ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒå…¥å®¤ã§ãã‚‹ç‰¹åˆ¥ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«å‚åŠ ã§ãã¾ã™ã€‚<br>
            ãƒ»<b>æœ¬äººè¨¼æ˜ã®å›ºå®š</b>ï¼šåå‰ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã«å›ºå®šã•ã‚Œã€ãªã‚Šã™ã¾ã—ã‚’é˜²æ­¢ã€‚ä¿¡é ¼æ€§ã®é«˜ã„ã‚„ã‚Šå–ã‚ŠãŒå¯èƒ½ã§ã™ã€‚<br>
            ãƒ»<b>å°‚ç”¨æ²ç¤ºæ¿ã®ä½œæˆ</b>ï¼šæ²ç¤ºæ¿ä½œæˆæ™‚ã«ã€Œãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼é™å®šã€ã®è¨­å®šã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br>
            ãƒ»<b>ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</b>ï¼šãƒã‚¤ãƒšãƒ¼ã‚¸æ©Ÿèƒ½ãŒå®Ÿè£…æ¸ˆã¿ã§ã™ã€‚ã¾ãŸç™»éŒ²è€…é™å®šã®ä¾¿åˆ©ãªæ©Ÿèƒ½ã‚’é †æ¬¡è¿½åŠ äºˆå®šã§ã™ã€‚<br><br>
            
            <strong>ã€åŸºæœ¬è¦ç´„ã€‘</strong><br>
            1. æŠ•ç¨¿ã•ã‚ŒãŸå†…å®¹ã®è‘—ä½œæ¨©ã¯ç®¡ç†è€…ã«å¸°å±ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚<br>
            2. ä»–è€…ã¸ã®èª¹è¬—ä¸­å‚·ã€ä¸é©åˆ‡ç”»åƒã®æŠ•ç¨¿ã€è’ã‚‰ã—è¡Œç‚ºã‚’å›ºãç¦ã˜ã¾ã™ã€‚<br>
            3. è¦ç´„é•åãŒç¢ºèªã•ã‚ŒãŸå ´åˆã€ç®¡ç†è€…ã®åˆ¤æ–­ã§æŠ•ç¨¿ã®å‰Šé™¤ã€ãŠã‚ˆã³ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆBANï¼‰ã‚’è¡Œã„ã¾ã™ã€‚<br>
            4. è’ã‚‰ã—è¡Œç‚ºç­‰ã€é‹å–¶ã‚’å¦¨å®³ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¤ã„ã¦ã¯ã€ç®¡ç†è€…ã®åˆ¤æ–­ã§è­˜åˆ¥æƒ…å ±ï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ï¼‰ã‚’å…¬é–‹ãƒ»æä¾›ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
            5. æœ¬ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸãƒˆãƒ©ãƒ–ãƒ«ã«ã¤ã„ã¦ã€ç®¡ç†è€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚<br>
            6. æ²ç¤ºæ¿ã¸ã®æ›¸ãè¾¼ã¿ã€æ²ç¤ºæ¿ã®ä½œæˆã‚’è¡Œã£ãŸæ™‚ç‚¹ã§ã“ã®è¦ç´„ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã—ã¾ã™ã€‚
        </div>
    </div>
    <a href="https://soulkin19.github.io/login/" class="btn-reg">ç„¡æ–™ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²</a>

    <button class="btn-create" onclick="createNewBoard()">è¦ç´„ã«åŒæ„ã—ã¦æ²ç¤ºæ¿ã‚’ä½œæˆã™ã‚‹</button>
    <div class="board-grid" id="board-list"></div>
</div>

<div class="container" id="bbs-view">
    <div id="current-board-title"></div>
    <input type="text" id="username" class="form-input" placeholder="åå‰">
    <textarea id="content" class="form-textarea" placeholder="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ>>1 ã§ã‚¢ãƒ³ã‚«ãƒ¼ï¼‰"></textarea>
    <input type="file" id="image-input" accept="image/*" style="display:none;" onchange="previewImage(this)">
    <img id="preview-area" class="img-preview">
    <div class="btn-group">
        <button class="btn-green" onclick="sendPost()">æŠ•ç¨¿</button>
        <button class="btn-green" style="background-color: #666;" onclick="document.getElementById('image-input').click()">ç”»åƒé¸æŠ</button>
        <button class="btn-green" style="background-color: #999;" onclick="location.reload()">æˆ»ã‚‹</button>
    </div>
    <div id="message-container"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCwhHspaG94goiCIjVj3h-Un5pBK3JTjMU",
        authDomain: "soulkin-aa3b7.firebaseapp.com",
        projectId: "soulkin-aa3b7",
        appId: "1:358331064206:web:d7760ea0919259418a4edf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ADMIN_PASS = "ZGVsdGE0Mzc="; 

    const sanitize = (str) => str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const parseAnchor = (text) => text.replace(/&gt;&gt;(\d+)/g, '<span class="anchor" onclick="document.getElementById(\'post-$1\').scrollIntoView({behavior:\'smooth\'})">>>$1</span>');

    const loginUser = localStorage.getItem("loginnow");

    const myId = (() => {
        let id = localStorage.getItem('fp');
        if (!id) { id = 'fp_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('fp', id); }
        return id;
    })();

    let currentBoardId = '';
    let currentBoardIsPrivate = false;
    let compressedImageData = '';
    let unsubscribeMessages = null;

    (async () => {
        const blackSnap = await getDoc(doc(db, 'blacklist', myId));
        if (blackSnap.exists() && blackSnap.data().type === 'perm') location.href = "https://soulkin19.github.io/soulch_ura";
        
        if(loginUser) {
            document.getElementById('username').value = loginUser;
            document.getElementById('username').readOnly = true;
            document.getElementById('username').style.background = "#eee";
        } else {
            document.getElementById('username').value = localStorage.getItem('e_chan_name') || "åç„¡ã—ã•ã‚“";
        }
    })();

    window.previewImage = (input) => {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height, max = 300;
                if (width > height) { if (width > max) { height *= max / width; width = max; } }
                else { if (height > max) { width *= max / height; height = max; } }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.width > 0 ? canvas.getContext('2d') : null;
                if(ctx) {
                    ctx.drawImage(img, 0, 0, width, height);
                    compressedImageData = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('preview-area').src = compressedImageData;
                    document.getElementById('preview-area').style.display = 'block';
                }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    };

    onSnapshot(query(collection(db, 'boards'), orderBy('lastUpdated', 'desc')), (snap) => {
        const list = document.getElementById('board-list');
        list.innerHTML = '';
        snap.forEach(d => {
            const b = d.data();
            const card = document.createElement('div');
            card.className = 'board-card';
            card.onclick = (e) => { 
                if(e.target.className !== 'board-del') {
                    if(b.isPrivate && !loginUser) {
                        alert("ã“ã®éƒ¨å±‹ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼é™å®šã§ã™ã€‚");
                        return;
                    }
                    openBoard(d.id, b.title, b.isPrivate); 
                }
            };
            onSnapshot(collection(db, `boards/${d.id}/messages`), (mSnap) => {
                card.innerHTML = `<button class="board-del" onclick="deleteBoard('${d.id}')">Ã—</button>
                    <div class="board-title">${b.isPrivate ? '<span class="lock-icon">ğŸ”’</span>' : ''}${sanitize(b.title)}</div>
                    <div class="post-count">æŠ•ç¨¿æ•°: ${mSnap.size}</div>`;
            });
            list.appendChild(card);
        });
    });

    window.openBoard = (id, title, isPrivate) => {
        currentBoardId = id;
        currentBoardIsPrivate = isPrivate;
        document.getElementById('top-view').style.display = 'none';
        document.getElementById('bbs-view').style.display = 'block';
        document.getElementById('current-board-title').innerText = title;

        if(isPrivate) {
            document.getElementById('username').value = loginUser;
            document.getElementById('username').readOnly = true;
            document.getElementById('username').style.background = "#eee";
        }

        if (unsubscribeMessages) unsubscribeMessages();

        unsubscribeMessages = onSnapshot(query(collection(db, `boards/${id}/messages`), orderBy('timestamp', 'asc')), (snap) => {
            const container = document.getElementById('message-container');
            container.innerHTML = '';
            let count = 1;
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = 'post-item';
                div.id = `post-${count}`;
                const apKey = m.uid ? m.uid.slice(-4).toUpperCase() : '????';
                div.innerHTML = `
                    <div class="post-user">${count}: ${sanitize(m.username)}</div>
                    <div class="post-text">${parseAnchor(sanitize(m.text))}</div>
                    ${m.imageUrl ? `<img src="${m.imageUrl}" class="post-img" onclick="window.open('${m.imageUrl}')">` : ''}
                    <div class="reaction-bar">
                        <button class="reaction-btn" onclick="handleReact('${d.id}', 'kusa')">ğŸ˜‚ ${m.kusa || 0}</button>
                        <button class="reaction-btn" onclick="handleReact('${d.id}', 'good')">ğŸ‘ ${m.good || 0}</button>
                        <button class="reaction-btn" onclick="handleReact('${d.id}', 'kami')">ğŸ˜² ${m.kami || 0}</button>
                    </div>
                    <div class="post-footer">
                        ${new Date(m.timestamp).toLocaleString()} | Key: <span class="ap-key">${apKey}</span>
                        <span class="admin-del" onclick="admin('${d.id}', '${m.uid}')">[ç®¡ç†]</span>
                    </div>
                `;
                container.prepend(div);
                count++;
            });
        });
    };

    window.handleReact = async (mId, type) => {
        const ref = doc(db, `boards/${currentBoardId}/messages`, mId);
        await updateDoc(ref, { [type]: increment(1) }).catch(err => console.error("Update error", err));
    };

    window.sendPost = async () => {
        const txt = document.getElementById('content').value;
        const name = document.getElementById('username').value;
        if (!txt && !compressedImageData) return;
        
        const finalName = currentBoardIsPrivate ? loginUser : name;

        if(!currentBoardIsPrivate) localStorage.setItem('e_chan_name', finalName);

        const now = Date.now();
        await addDoc(collection(db, `boards/${currentBoardId}/messages`), {
            username: finalName, text: txt, timestamp: now, uid: myId, imageUrl: compressedImageData, 
            kusa: 0, good: 0, kami: 0
        });
        await setDoc(doc(db, 'boards', currentBoardId), { lastUpdated: now }, { merge: true });
        document.getElementById('content').value = '';
        document.getElementById('preview-area').style.display = 'none';
        compressedImageData = '';
    };

    window.admin = async (mId, uId) => {
        const p = prompt("PASS:");
        if (p && btoa(p) === ADMIN_PASS) {
            const a = prompt("1:æ¶ˆå» 2:æ°¸ä¹…BAN");
            if (a === "1") await deleteDoc(doc(db, `boards/${currentBoardId}/messages`, mId));
            else if (a === "2") await setDoc(doc(db, 'blacklist', uId), { type: 'perm' });
        }
    };

    window.createNewBoard = async () => {
        const t = prompt("æ²ç¤ºæ¿å:");
        if (t) {
            let isPriv = false;
            if(loginUser) {
                isPriv = confirm("ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼é™å®šã®éƒ¨å±‹ã«ã—ã¾ã™ã‹ï¼Ÿ");
            }
            
            await addDoc(collection(db, 'boards'), { 
                title: t, 
                lastUpdated: Date.now(),
                isPrivate: isPriv 
            });
        }
    };

    window.deleteBoard = async (id) => {
        event.stopPropagation();
        const p = prompt("å‰Šé™¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:");
        if (p && btoa(p) === ADMIN_PASS) await deleteDoc(doc(db, 'boards', id));
    };
</script>
</body>
</html>
